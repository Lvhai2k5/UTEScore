<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>üí¨ G√≥p √Ω & ƒê√°nh gi√° | UTEScore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      font-family:'Segoe UI', Tahoma, sans-serif;
      background:linear-gradient(180deg,#f9fafb,#f0f4f8);
    }
    nav.navbar,footer {
      background:linear-gradient(90deg,#16a34a,#3b82f6);
      color:white;
    }
    footer {
      text-align:center;
      padding:10px 0;
      font-size:14px;
      position:fixed;
      bottom:0;left:0;right:0;
      z-index:999;
    }

    /* ==== HERO ==== */
    .hero-section {
      background:linear-gradient(135deg,#3b82f6,#22c55e);
      color:white;
      text-align:center;
      padding:80px 20px;
      border-bottom-left-radius:50px;
      border-bottom-right-radius:50px;
      box-shadow:0 10px 25px rgba(0,0,0,0.1);
      margin-top: 75px;
    }
    .user-avatar {
      width:90px;height:90px;
      border-radius:50%;
      border:3px solid #fff;
      box-shadow:0 4px 15px rgba(255,255,255,0.5);
    }

    /* ==== TH·∫∫ CH·ª®C NƒÇNG ==== */
    .feature-card {
      background:#fff;
      border-radius:25px;
      box-shadow:0 5px 18px rgba(0,0,0,0.08);
      padding:40px 30px;
      text-align:center;
      transition:transform .3s ease, box-shadow .3s ease;
    }
    .feature-card:hover {
      transform:scale(1.05);
      box-shadow:0 10px 25px rgba(0,0,0,0.15);
    }

    /* üåü TƒÉng k√≠ch th∆∞·ªõc ch·ªØ cho 2 th·∫ª */
    .feature-card h5 {
      font-size:1.9rem;
      font-weight:700;
      color:#111827;
      margin-top:10px;
    }
    .feature-card p {
      font-size:1.2rem;
      color:#374151;
      margin:15px 0 25px;
    }
    .feature-icon {
      font-size:3rem;
    }

    /* ==== FORM & TABLE ==== */
    .feedback-form,.history-table {
      background:#fff;
      border-radius:25px;
      padding:30px;
      box-shadow:0 8px 25px rgba(0,0,0,0.1);
      max-width:900px;
      margin:30px auto;
      display:none;
    }
    .show {
      display:block!important;
      animation:fadeIn .5s ease;
    }
    @keyframes fadeIn {
      from{opacity:0;transform:translateY(30px);}
      to{opacity:1;transform:translateY(0);}
    }
    .close-btn {
      position:absolute;
      top:10px;
      right:15px;
      background:none;
      border:none;
      font-size:24px;
      cursor:pointer;
      color:#6b7280;
    }
    .stars i {
      font-size:28px;
      color:#d1d5db;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div th:replace="~{fragments/header :: header}"></div>

<section class="hero-section">
  <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="user-avatar mb-3" alt="avatar">
  <h1>üí¨ G√≥p √Ω & ƒê√°nh gi√°</h1>
  <p>UTEScore lu√¥n l·∫Øng nghe b·∫°n ƒë·ªÉ ho√†n thi·ªán d·ªãch v·ª• ‚öΩ</p>
</section>

<main class="container pb-5">

  <!-- CH·ªåN T√çNH NƒÇNG -->
  <div class="row g-4 justify-content-center mt-4">
    <div class="col-md-5">
      <div class="feature-card">
        <div class="feature-icon fs-1">‚≠ê</div>
        <h5>ƒê√°nh gi√° ƒë∆°n h√†ng</h5>
        <p>ƒê√°nh gi√° s√¢n b·∫°n ƒë√£ t·ª´ng ƒë·∫∑t v√† tr·∫£i nghi·ªám.</p>
        <button class="btn btn-success" onclick="openOrderForm()">ƒê√°nh gi√° ngay</button>
        <button class="btn btn-outline-success" onclick="loadReviewHistory()">L·ªãch s·ª≠</button>
      </div>
    </div>
    <div class="col-md-5">
      <div class="feature-card">
        <div class="feature-icon fs-1">üí°</div>
        <h5>G√≥p √Ω h·ªá th·ªëng</h5>
        <p>ƒê∆∞a ra g√≥p √Ω ƒë·ªÉ UTEScore ph·ª•c v·ª• b·∫°n t·ªët h∆°n.</p>
        <button class="btn btn-primary" onclick="openFeedbackForm()">G√≥p √Ω ngay</button>
        <button class="btn btn-outline-primary" onclick="loadFeedbackHistory()">L·ªãch s·ª≠</button>
      </div>
    </div>
  </div>

  <!-- ‚≠ê FORM ƒê√ÅNH GI√Å -->
  <div id="orderForm" class="feedback-form position-relative">
    <button class="close-btn" onclick="toggleSection()">&times;</button>
    <h4 class="fw-bold text-center mb-4">‚≠ê ƒê√°nh gi√° ƒë∆°n ƒë·∫∑t s√¢n</h4>
    <form id="orderRatingForm" th:action="@{/customer/feedback/order}" method="post">
      <div class="mb-3">
        <label class="form-label fw-semibold">Ch·ªçn ƒë∆°n ƒë·∫∑t s√¢n</label>
        <select class="form-select" name="maDonDat" id="maDonDat" required></select>
      </div>
      <div class="mb-3 text-center stars" id="starContainer">
        <i class="bi bi-star" data-val="1"></i>
        <i class="bi bi-star" data-val="2"></i>
        <i class="bi bi-star" data-val="3"></i>
        <i class="bi bi-star" data-val="4"></i>
        <i class="bi bi-star" data-val="5"></i>
        <input type="hidden" name="rating" id="ratingValue">
      </div>
      <div class="mb-3">
        <label class="form-label fw-semibold">N·ªôi dung ƒë√°nh gi√°</label>
        <textarea class="form-control" name="noiDung" rows="4" required></textarea>
      </div>
      <div class="text-center">
        <button type="submit" class="btn btn-success px-4 py-2"><i class="bi bi-send-fill"></i> G·ª≠i ƒë√°nh gi√°</button>
      </div>
    </form>
  </div>

  <!-- ‚≠ê L·ªäCH S·ª¨ ƒê√ÅNH GI√Å -->
  <div id="reviewHistory" class="history-table position-relative">
    <button class="close-btn" onclick="toggleSection()">&times;</button>
    <h4 class="fw-bold text-center mb-4">‚≠ê L·ªãch s·ª≠ ƒë√°nh gi√°</h4>
    <table class="table table-hover align-middle text-center">
      <thead><tr><th>T√™n s√¢n</th><th>‚≠ê</th><th>N·ªôi dung</th><th>Ng√†y</th><th>Thao t√°c</th></tr></thead>
      <tbody id="reviewTableBody"><tr><td colspan="5"><div class="spinner-border"></div></td></tr></tbody>
    </table>
  </div>

  <!-- üí° FORM G√ìP √ù -->
  <div id="systemForm" class="feedback-form position-relative">
    <button class="close-btn" onclick="toggleSection()">&times;</button>
    <h4 class="fw-bold text-center mb-4">üí° G√≥p √Ω h·ªá th·ªëng</h4>
    <form id="systemFeedbackForm" th:action="@{/customer/feedback/system}" method="post">
      <div class="mb-3">
        <label class="form-label fw-semibold">Ch·ªß ƒë·ªÅ g√≥p √Ω</label>
        <select class="form-select" name="chuDe" id="chuDeSelect" required>
          <option value="Chung">Chung</option>
          <option value="H·ªá th·ªëng">H·ªá th·ªëng</option>
          <option value="Gi√° c·∫£">Gi√° c·∫£</option>
          <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
          <option value="S√¢n b√≥ng">S√¢n b√≥ng</option>
        </select>
      </div>
      <div class="mb-3" id="sanSelectDiv" style="display:none;">
        <label class="form-label fw-semibold">Ch·ªçn s√¢n b√≥ng</label>
        <select class="form-select" id="sanBongSelect" name="maSan"></select>
      </div>
      <div class="mb-3">
        <label class="form-label fw-semibold">N·ªôi dung g√≥p √Ω</label>
        <textarea class="form-control" name="noiDung" rows="4" required></textarea>
      </div>
      <div class="text-center">
        <button class="btn btn-primary px-4 py-2"><i class="bi bi-send-fill"></i> G·ª≠i g√≥p √Ω</button>
      </div>
    </form>
  </div>

  <!-- üí° L·ªäCH S·ª¨ G√ìP √ù -->
  <div id="feedbackHistory" class="history-table position-relative">
    <button class="close-btn" onclick="toggleSection()">&times;</button>
    <h4 class="fw-bold text-center mb-4">üí° L·ªãch s·ª≠ g√≥p √Ω</h4>
    <table class="table table-hover align-middle text-center">
      <thead><tr><th>Ch·ªß ƒë·ªÅ</th><th>N·ªôi dung</th><th>S√¢n b√≥ng</th><th>Ng√†y g·ª≠i</th><th>Thao t√°c</th></tr></thead>
      <tbody id="feedbackTableBody"><tr><td colspan="5"><div class="spinner-border"></div></td></tr></tbody>
    </table>
  </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("‚úÖ JS Loaded All");

  // ======= D√ôNG CHUNG =======
  window.toggleSection = (id)=>{
    document.querySelectorAll('.feedback-form,.history-table').forEach(e=>e.classList.remove('show'));
    if(!id)return;
    document.getElementById(id).classList.add('show');
    window.scrollTo({top:0,behavior:'smooth'});
  };

  // ======= ‚≠ê PH·∫¶N ƒê√ÅNH GI√Å =======
  const stars=document.querySelectorAll('#starContainer i');
  stars.forEach(star=>{
    star.addEventListener('mouseover',()=>fillStars(star.dataset.val));
    star.addEventListener('mouseout',()=>fillStars(document.getElementById('ratingValue').value));
    star.addEventListener('click',()=>{document.getElementById('ratingValue').value=star.dataset.val;fillStars(star.dataset.val);});
  });
  function fillStars(val){stars.forEach(s=>{if(s.dataset.val<=val){s.classList.replace('bi-star','bi-star-fill');s.style.color='#facc15';}else{s.classList.replace('bi-star-fill','bi-star');s.style.color='#d1d5db';}});}

  window.openOrderForm = async ()=>{
    const form=document.getElementById('orderRatingForm');
    form.reset();delete form.dataset.editId;
    document.getElementById('ratingValue').value='';fillStars(0);
    const select=document.getElementById('maDonDat');
    select.disabled=false;select.innerHTML='<option>‚è≥ ƒêang t·∫£i...</option>';
    toggleSection('orderForm');
    const res=await fetch('/customer/feedback/eligible-orders');
    const json=await res.json();
    if(!json.length){select.innerHTML='<option>Kh√¥ng c√≥ ƒë∆°n h√†ng ƒë·ªß ƒëi·ªÅu ki·ªán</option>';return;}
    select.innerHTML='<option value="">-- Ch·ªçn ƒë∆°n h√†ng --</option>';
    json.forEach(d=>{
      const date=d.ngayDa?new Date(d.ngayDa).toLocaleDateString('vi-VN'):'';
      select.innerHTML+=`<option value="${d.maDonDat}">#${d.maDonDat} | ${d.tenSan} | ${date}</option>`;
    });
  };

  document.getElementById('orderRatingForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const form=e.target;
    const data=new URLSearchParams(new FormData(form));
    if(form.dataset.editId)data.append("maDanhGia",form.dataset.editId);
    const maDonDat=document.getElementById('maDonDat').value;
    if(!data.has("maDonDat"))data.append("maDonDat",maDonDat);
    const res=await fetch(form.action,{method:'POST',body:data});
    const text=await res.text();
    if(text.includes('SUCCESS'))
      Swal.fire('üéâ Th√†nh c√¥ng',form.dataset.editId?'ƒê√£ c·∫≠p nh·∫≠t ƒë√°nh gi√°!':'C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!','success');
    else if(text.includes('ALREADY_RATED'))
      Swal.fire('‚ö†Ô∏è L∆∞u √Ω','ƒê∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c ƒë√°nh gi√° r·ªìi!','warning');
    else Swal.fire('‚ùå L·ªói','Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°.','error');
    toggleSection();
  });

  window.loadReviewHistory=async()=>{
    toggleSection('reviewHistory');
    const body=document.getElementById('reviewTableBody');
    body.innerHTML='<tr><td colspan="5"><div class="spinner-border"></div></td></tr>';
    const res=await fetch('/customer/feedback/reviews');
    const json=await res.json();body.innerHTML='';
    if(!json.length){body.innerHTML='<tr><td colspan="5" class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</td></tr>';return;}
    json.forEach(r=>{
      const stars='‚òÖ'.repeat(r.rating)+'‚òÜ'.repeat(5-r.rating);
      body.innerHTML+=`
        <tr>
          <td>${r.tenSan}</td>
          <td>${stars}</td>
          <td>${r.noiDung}</td>
          <td>${new Date(r.ngayDanhGia).toLocaleString('vi-VN')}</td>
          <td><button class="btn btn-sm btn-outline-primary"
            onclick="editReview(${r.maDanhGia},${r.rating},'${r.noiDung.replace(/'/g,"\\'")}',${r.maDonDat},'${r.tenSan}','${r.ngayDa}')">
            <i class="bi bi-pencil-square"></i></button></td></tr>`;
    });
  };

  window.editReview=(maDanhGia,rating,noiDung,maDonDat,tenSan,ngayDa)=>{
    toggleSection('orderForm');
    const form=document.getElementById('orderRatingForm');
    form.dataset.editId=maDanhGia;
    form.querySelector('textarea[name=noiDung]').value=noiDung;
    document.getElementById('ratingValue').value=rating;fillStars(rating);
    const select=document.getElementById('maDonDat');
    const formattedDate=ngayDa?new Date(ngayDa).toLocaleDateString('vi-VN'):'';
    select.innerHTML=`<option value="${maDonDat}" selected>#${maDonDat} | ${tenSan} | ${formattedDate}</option>`;
    select.disabled=true;
  };

  // ======= üí° PH·∫¶N G√ìP √ù =======
  const chuDeSelect=document.getElementById('chuDeSelect');
  chuDeSelect.addEventListener('change',e=>{
    document.getElementById('sanSelectDiv').style.display=e.target.value==='S√¢n b√≥ng'?'block':'none';
  });

  window.openFeedbackForm=async()=>{
    const form=document.getElementById('systemFeedbackForm');
    form.reset();delete form.dataset.editId;
    chuDeSelect.value='Chung';document.getElementById('sanSelectDiv').style.display='none';
    toggleSection('systemForm');
    const res=await fetch('/customer/sanbong/all');
    const json=await res.json();
    const sanSel=document.getElementById('sanBongSelect');
    sanSel.innerHTML='<option value="">-- Ch·ªçn s√¢n b√≥ng --</option>';
    json.forEach(s=>sanSel.innerHTML+=`<option value="${s.maSan}">${s.tenSan}</option>`);
  };

  window.loadFeedbackHistory=async()=>{
    toggleSection('feedbackHistory');
    const body=document.getElementById('feedbackTableBody');
    body.innerHTML='<tr><td colspan="5"><div class="spinner-border"></div></td></tr>';
    const res=await fetch('/customer/feedback/system-history');
    const json=await res.json();body.innerHTML='';
    if(!json.length){body.innerHTML='<tr><td colspan="5" class="text-muted">Ch∆∞a c√≥ g√≥p √Ω n√†o</td></tr>';return;}
    json.forEach(f=>{
      const date=new Date(f.ngayGopY).toLocaleString('vi-VN');
      const tenSan=f.tenSan?f.tenSan:'-';
      body.innerHTML+=`
        <tr><td>${f.chuDe}</td><td>${f.noiDung}</td><td>${tenSan}</td><td>${date}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1"
              onclick="editFeedback(${f.maGopY},'${f.chuDe}','${f.noiDung.replace(/'/g,"\\'")}',${f.maSan||'null'},'${f.tenSan||''}')">
              <i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteFeedback(${f.maGopY})">
              <i class="bi bi-trash"></i></button></td></tr>`;
    });
  };

  window.editFeedback=async(id,chuDe,noiDung,maSan,tenSan)=>{
    toggleSection('systemForm');
    const form=document.getElementById('systemFeedbackForm');
    form.dataset.editId=id;
    form.querySelector('#chuDeSelect').value=chuDe;
    form.querySelector('textarea[name=noiDung]').value=noiDung;
    const sanDiv=document.getElementById('sanSelectDiv');
    const sanSel=document.getElementById('sanBongSelect');
    if(chuDe==='S√¢n b√≥ng'){
      sanDiv.style.display='block';
      const res=await fetch('/customer/sanbong/all');
      const json=await res.json();
      sanSel.innerHTML='<option value="">-- Ch·ªçn s√¢n b√≥ng --</option>';
      json.forEach(s=>{const selected=(s.maSan===maSan)?'selected':'';sanSel.innerHTML+=`<option value="${s.maSan}" ${selected}>${s.tenSan}</option>`;});
    }else sanDiv.style.display='none';
  };

  window.deleteFeedback=async(id)=>{
    const confirm=await Swal.fire({title:'X√≥a g√≥p √Ω?',text:'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?',icon:'warning',showCancelButton:true,confirmButtonText:'X√≥a',cancelButtonText:'H·ªßy'});
    if(!confirm.isConfirmed)return;
    const data=new URLSearchParams();data.append("maGopY",id);
    const res=await fetch('/customer/feedback/delete',{method:'POST',body:data});
    const text=await res.text();
    if(text.includes('SUCCESS')){Swal.fire('‚úÖ ƒê√£ x√≥a!','','success');loadFeedbackHistory();}
    else Swal.fire('‚ùå L·ªói','Kh√¥ng th·ªÉ x√≥a.','error');
  };

  document.getElementById('systemFeedbackForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const form=e.target;
    const data=new URLSearchParams(new FormData(form));
    if(form.dataset.editId)data.append("maGopY",form.dataset.editId);
    const res=await fetch(form.action,{method:'POST',body:data});
    const text=await res.text();
    if(text.includes('SUCCESS'))
      Swal.fire('‚úÖ Th√†nh c√¥ng',form.dataset.editId?'ƒê√£ c·∫≠p nh·∫≠t g√≥p √Ω!':'ƒê√£ g·ª≠i g√≥p √Ω m·ªõi!','success');
    else Swal.fire('‚ùå L·ªói','Kh√¥ng th·ªÉ g·ª≠i/c·∫≠p nh·∫≠t.','error');
    toggleSection();
  });

});
</script>
</body>
</html>
