<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>T√†i kho·∫£n c√° nh√¢n | UTEScore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ‚úÖ Bootstrap + Icons + SweetAlert -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(180deg, #f1f5f9 0%, #e0f2fe 100%);
    }

    main {
      padding-top: 110px;
      padding-bottom: 80px;
    }

    .account-container {
      max-width: 850px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.1);
      padding: 40px;
      animation: fadeIn .6s ease-in-out;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(30px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .avatar {
      width: 120px; height: 120px; border-radius: 50%;
      border: 4px solid #3b82f6; object-fit: cover;
      margin: 0 auto 20px; display: block;
    }

    .btn-action {
      border: none; border-radius: 10px;
      padding: 10px 24px; font-weight: 600;
      color: #fff; transition: 0.3s;
    }

    .btn-edit { background: #0ea5e9; }
    .btn-save { background: linear-gradient(90deg, #2563eb, #16a34a); box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
    .btn-cancel { background: #ef4444; box-shadow: 0 4px 10px rgba(239,68,68,0.3); }

    .btn-edit:hover, .btn-save:hover, .btn-cancel:hover { transform: scale(1.05); }

    input[readonly], input:disabled { background-color: #f1f5f9; }

    /* ===== ‚ö†Ô∏è C·∫£nh b√°o ===== */
    .is-invalid {
      border-color: #dc2626 !important;
      background-image: url('https://cdn-icons-png.flaticon.com/512/1828/1828843.png');
      background-repeat: no-repeat;
      background-size: 20px;
      background-position: right 10px center;
      animation: shake 0.3s ease;
    }

    .invalid-feedback {
      display: block;
      color: #dc2626;
      font-weight: 500;
      margin-top: 4px;
      font-size: 0.9rem;
    }

    .btn-save:disabled { background: gray !important; cursor: not-allowed; box-shadow: none !important; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); }
      75% { transform: translateX(-4px); }
    }
  </style>
</head>

<body>
  <div th:replace="fragments/header :: header"></div>

  <main>
    <div class="account-container">
      <!-- ================= TH√îNG TIN C√Å NH√ÇN ================= -->
      <h3 class="text-center fw-bold text-primary mb-4">üë§ Th√¥ng tin t√†i kho·∫£n</h3>

      <div class="text-center mb-3">
        <img id="previewAvatar"
             th:if="${anhBase64 != null}"
             th:src="@{'data:image/png;base64,' + ${anhBase64}}"
             class="avatar"/>
        <img th:if="${anhBase64 == null}"
             src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png"
             id="previewAvatar" class="avatar"/>
      </div>

      <div class="text-end mb-3">
        <button type="button" id="btnEditInfo" class="btn btn-edit btn-action">‚úèÔ∏è C·∫≠p nh·∫≠t th√¥ng tin</button>
      </div>

      <form id="formInfo" enctype="multipart/form-data" novalidate>
        <div class="mb-3">
          <label class="form-label fw-semibold">H·ªç v√† t√™n</label>
          <input type="text" name="HoTen" th:value="${khachHang.hoTen}" class="form-control" readonly required>
          <div class="invalid-feedback"></div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Email</label>
          <input type="email" name="Email" th:value="${khachHang.email}"
                 class="form-control" readonly tabindex="-1"
                 style="pointer-events:none;user-select:none;background:#f1f5f9;">
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="text" name="SoDienThoai" th:value="${khachHang.soDienThoai}" class="form-control" maxlength="11" readonly required>
          <div class="invalid-feedback"></div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">·∫¢nh ƒë·∫°i di·ªán</label>
          <input type="file" name="anhDaiDienFile" id="anhDaiDienFile" class="form-control" disabled>
          <div class="invalid-feedback"></div>
        </div>

        <div class="text-center mt-4 d-flex justify-content-center gap-3">
          <button type="submit" class="btn btn-save btn-action d-none" id="btnSaveInfo" disabled>üíæ L∆∞u thay ƒë·ªïi</button>
          <button type="button" class="btn btn-cancel btn-action d-none" id="btnCancelInfo">‚ùå H·ªßy</button>
        </div>
      </form>

      <hr class="my-5">

      <!-- ================= ƒê·ªîI M·∫¨T KH·∫®U ================= -->
      <h3 class="text-center fw-bold text-primary mb-4">üîë ƒê·ªïi m·∫≠t kh·∫©u</h3>
      <div class="text-end mb-3">
        <button type="button" id="btnEditPass" class="btn btn-edit btn-action">üîê C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
      </div>

      <form id="formPass" novalidate>
        <div class="mb-3">
          <label class="form-label fw-semibold">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
          <input type="password" name="oldPassword" class="form-control" readonly required>
          <div class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">M·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" name="newPassword" class="form-control" readonly required minlength="6">
          <div class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" name="confirmPassword" class="form-control" readonly required>
          <div class="invalid-feedback"></div>
        </div>
        <div class="text-center mt-4 d-flex justify-content-center gap-3">
          <button type="submit" class="btn btn-save btn-action d-none" id="btnSavePass" disabled>üíæ C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
          <button type="button" class="btn btn-cancel btn-action d-none" id="btnCancelPass">‚ùå H·ªßy</button>
        </div>
      </form>
    </div>
  </main>

  <div th:replace="fragments/footer :: footer"></div>

  <!-- ‚úÖ SCRIPT -->
  <script>
    // ====== Bi·∫øn form ======
    const nameInput = document.querySelector('[name="HoTen"]');
    const phoneInput = document.querySelector('[name="SoDienThoai"]');
    const fileInput = document.querySelector('[name="anhDaiDienFile"]');
    const formInfo = document.getElementById('formInfo');
    const saveInfoBtn = document.getElementById('btnSaveInfo');
    const cancelInfoBtn = document.getElementById('btnCancelInfo');

    const passForm = document.getElementById('formPass');
    const oldPass = passForm.oldPassword;
    const newPass = passForm.newPassword;
    const confirmPass = passForm.confirmPassword;
    const savePassBtn = document.getElementById('btnSavePass');
    const cancelPassBtn = document.getElementById('btnCancelPass');

    // Regex ki·ªÉm tra
    const nameRegex = /^[A-Za-z√Ä-·ª∏√†-·ªπƒÇƒÉ√Ç√¢√ä√™√î√¥∆†∆°∆Ø∆∞ƒêƒë\s]{2,50}$/;
    const phoneRegex = /^0\d{9,10}$/;

    // ====== H√†m x·ª≠ l√Ω l·ªói ======
    function setInvalid(input, msg) {
      input.classList.add('is-invalid');
      input.nextElementSibling.textContent = msg;
    }
    function clearInvalid(input) {
      input.classList.remove('is-invalid');
      input.nextElementSibling.textContent = '';
    }

    // ====== Validate th√¥ng tin c√° nh√¢n ======
    function validateInfo() {
      let valid = true;
      clearInvalid(nameInput); clearInvalid(phoneInput); clearInvalid(fileInput);
      if (!nameRegex.test(nameInput.value.trim())) {
        setInvalid(nameInput, "‚ö†Ô∏è H·ªç t√™n kh√¥ng h·ª£p l·ªá! (Kh√¥ng ch·ª©a s·ªë ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát)");
        valid = false;
      }
      if (!phoneRegex.test(phoneInput.value.trim())) {
        setInvalid(phoneInput, "‚ö†Ô∏è S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! (B·∫Øt ƒë·∫ßu b·∫±ng 0 v√† c√≥ 10‚Äì11 s·ªë)");
        valid = false;
      }
      if (fileInput.files.length > 0 && !['image/png', 'image/jpeg'].includes(fileInput.files[0].type)) {
        setInvalid(fileInput, "‚ö†Ô∏è ·∫¢nh ƒë·∫°i di·ªán ch·ªâ ch·∫•p nh·∫≠n JPG ho·∫∑c PNG!");
        valid = false;
      }
      saveInfoBtn.disabled = !valid;
      return valid;
    }

    [nameInput, phoneInput, fileInput].forEach(inp => inp.addEventListener('input', validateInfo));

    // ====== Validate m·∫≠t kh·∫©u ======
    function validatePass() {
      let valid = true;
      [oldPass, newPass, confirmPass].forEach(clearInvalid);

      if (!oldPass.value.trim()) {
        setInvalid(oldPass, "‚ö†Ô∏è Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i!");
        valid = false;
      }
      if (newPass.value.trim().length < 6) {
        setInvalid(newPass, "‚ö†Ô∏è M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!");
        valid = false;
      }
      if (confirmPass.value.trim() !== newPass.value.trim()) {
        setInvalid(confirmPass, "‚ö†Ô∏è M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp v·ªõi m·∫≠t kh·∫©u m·ªõi!");
        valid = false;
      }
      savePassBtn.disabled = !valid;
      return valid;
    }

    [oldPass, newPass, confirmPass].forEach(inp => inp.addEventListener('input', validatePass));

    // ====== N√∫t ch·ªânh s·ª≠a / h·ªßy ======
    document.getElementById('btnEditInfo').addEventListener('click', () => {
      [nameInput, phoneInput, fileInput].forEach(inp => inp.removeAttribute('readonly'));
      fileInput.removeAttribute('disabled');
      saveInfoBtn.classList.remove('d-none');
      cancelInfoBtn.classList.remove('d-none');
      validateInfo();
    });

    cancelInfoBtn.addEventListener('click', () => location.reload());

    document.getElementById('btnEditPass').addEventListener('click', () => {
      [oldPass, newPass, confirmPass].forEach(inp => inp.removeAttribute('readonly'));
      savePassBtn.classList.remove('d-none');
      cancelPassBtn.classList.remove('d-none');
      validatePass();
    });

    cancelPassBtn.addEventListener('click', () => location.reload());

    // ====== Xem tr∆∞·ªõc ·∫£nh ======
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => document.getElementById('previewAvatar').src = ev.target.result;
        reader.readAsDataURL(file);
      }
    });

    // ====== G·ª≠i form th√¥ng tin c√° nh√¢n ======
    formInfo.addEventListener('submit', async e => {
      e.preventDefault();
      if (!validateInfo()) {
        Swal.fire({
          icon: 'warning',
          title: '‚ö†Ô∏è C·∫£nh b√°o',
          html: `
            <p>B·∫°n nh·∫≠p kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!</p><hr>
            <p style="text-align:left;font-size:14px">
              <b>L∆∞u √Ω:</b><br>
              ‚Ä¢ H·ªç t√™n kh√¥ng ƒë∆∞·ª£c ch·ª©a s·ªë ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát.<br>
              ‚Ä¢ S·ªë ƒëi·ªán tho·∫°i ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 0 v√† c√≥ 10‚Äì11 ch·ªØ s·ªë.<br>
              ‚Ä¢ ·∫¢nh ch·ªâ ch·∫•p nh·∫≠n JPG ho·∫∑c PNG.
            </p>`,
          confirmButtonColor: '#f59e0b'
        });
        return;
      }

      const formData = new FormData(formInfo);
      const res = await fetch('/customer/account/update-ajax', { method: 'POST', body: formData });
      const data = await res.json();
      Swal.fire({
        icon: data.status === 'success' ? 'success' : 'error',
        title: data.status === 'success' ? '‚úÖ Th√†nh c√¥ng' : '‚ö†Ô∏è C·∫£nh b√°o',
        text: data.message,
        timer: 2000, showConfirmButton: false
      });
    });

    // ====== G·ª≠i form ƒë·ªïi m·∫≠t kh·∫©u ======
    passForm.addEventListener('submit', async e => {
      e.preventDefault();
      if (!validatePass()) {
        Swal.fire({
          icon: 'warning',
          title: '‚ö†Ô∏è C·∫£nh b√°o',
          html: `
            <p>B·∫°n nh·∫≠p m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá!</p><hr>
            <p style="text-align:left;font-size:14px">
              <b>L∆∞u √Ω:</b><br>
              ‚Ä¢ M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.<br>
              ‚Ä¢ M·∫≠t kh·∫©u x√°c nh·∫≠n ph·∫£i tr√πng v·ªõi m·∫≠t kh·∫©u m·ªõi.
            </p>`,
          confirmButtonColor: '#f59e0b'
        });
        return;
      }

      const formData = new FormData(passForm);
      const res = await fetch('/customer/account/change-password-ajax', { method: 'POST', body: formData });
      const data = await res.json();
      Swal.fire({
        icon: data.status === 'success' ? 'success' : 'error',
        title: data.status === 'success' ? '‚úÖ Th√†nh c√¥ng' : '‚ö†Ô∏è C·∫£nh b√°o',
        text: data.message,
        timer: 2000, showConfirmButton: false
      });
      if (data.status === 'success') passForm.reset();
    });
  </script>
</body>
</html>
