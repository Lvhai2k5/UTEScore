<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${pageTitle}">Äáº·t sÃ¢n | UTEScore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- âœ… Bootstrap & CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" th:href="@{/css/customer-home.css}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(180deg, #f8fafc, #e2e8f0);
      overflow: hidden;
    }

    .main-content {
      position: absolute;
      top: 70px;
      bottom: 60px;
      left: 0;
      right: 0;
      overflow-y: auto;
      padding: 40px 0;
    }

    .booking-wrapper {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      max-width: 950px;
      margin: auto;
      padding: 30px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pitch-img { width: 100%; height: 260px; object-fit: cover; border-radius: 12px; }
    .info-label { font-weight: 600; color: #374151; }

    .calc-box {
      background: #f1f5f9;
      border-radius: 12px;
      padding: 20px;
      margin-top: 15px;
    }

    .price-label, .deposit-label { font-size: 20px; font-weight: 700; }

    .btn-confirm {
      background: linear-gradient(90deg, #16a34a, #3b82f6);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.25s ease;
    }
    .btn-confirm:hover { opacity: 0.9; transform: translateY(-2px); }

    .table { background: #fff; border-radius: 12px; overflow: hidden; margin: auto; width: 80%; }
    .table th {
      background: linear-gradient(90deg, #16a34a, #3b82f6);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
    }
    .table td { font-size: 15px; color: #374151; vertical-align: middle; }
    .table-hover tbody tr:hover { background-color: #f1f5f9; }
  </style>
</head>

<body>

  <!-- âœ… HEADER -->
  <div th:replace="fragments/header :: header"></div>

  <!-- âœ… MAIN CONTENT -->
  <div class="main-content">
    <div class="container">
      <div class="booking-wrapper">

        <!-- áº¢nh sÃ¢n -->
        
         <img th:src="${pitchImg}" alt="SÃ¢n bÃ³ng" class="pitch-img mb-4">
     
        <h3 class="text-success fw-bold mb-3" th:text="${pitchName}">SÃ¢n 5A</h3>

        <!-- ThÃ´ng tin sÃ¢n -->
        <div class="row mb-3">
          <div class="col-md-6">
            <p><span class="info-label">Loáº¡i sÃ¢n:</span> <span th:text="${pitchType}">5 ngÆ°á»i</span></p>
            <p><span class="info-label">KÃ­ch thÆ°á»›c:</span> <span th:text="${pitchSize}">20 Ã— 40 m</span></p>
          </div>
          <div class="col-md-6">
            <p><span class="info-label">Khu vá»±c:</span> <span th:text="${pitchArea}">Khu A</span></p>
            <p><span class="info-label">Tráº¡ng thÃ¡i:</span>
              <span class="badge bg-success" th:text="${pitchStatus}">Hoáº¡t Ä‘á»™ng</span>
            </p>
          </div>
        </div>

        <hr>

        <!-- ğŸ“Š Báº£ng giÃ¡ thuÃª -->
        <div class="price-box mt-4">
          <h5 class="fw-bold mb-3 text-primary text-center">
            <span style="font-size:18px;">ğŸ“‹</span> Báº£ng giÃ¡ thuÃª
          </h5>
          <table class="table table-bordered text-center table-hover">
            <thead><tr><th>â° Khung giá»</th><th>ğŸ’° GiÃ¡ thuÃª (Ä‘/giá»)</th></tr></thead>
            <tbody id="priceList"></tbody>
          </table>
        </div>

        <!-- ğŸ’µ TÃ­nh tiá»n -->
        <div class="calc-box mt-4">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">ğŸ“… NgÃ y thi Ä‘áº¥u</label>
              <input type="date" id="date" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">ğŸ•’ Giá» báº¯t Ä‘áº§u</label>
              <select id="startTime" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">ğŸ•” Giá» káº¿t thÃºc</label>
              <select id="endTime" class="form-select"></select>
            </div>
          </div>

          <div class="mt-4">
            <h5 class="price-label text-danger">ğŸ’µ ThÃ nh tiá»n: <span id="price">0 Ä‘</span></h5>
            <h5 class="deposit-label text-primary">ğŸ’° Tiá»n cá»c (<span th:text="${depositPercentText}">30%</span>): 
              <span id="deposit">0 Ä‘</span>
            </h5>
          </div>
        </div>

        <!-- ğŸ”˜ NÃºt hÃ nh Ä‘á»™ng -->
        <div class="text-center mt-4">
          <a th:href="@{/customer/pitch-list}" class="btn btn-outline-secondary me-2">â¬…ï¸ Quay láº¡i</a>
          <button type="button" class="btn-confirm">ğŸ’³ XÃ¡c nháº­n & Thanh toÃ¡n</button>

          <!-- ğŸ§© Form áº©n -->
          <form id="bookingForm" th:action="@{/customer/booking/confirm}" method="post" style="display:none;">
            <input type="hidden" name="pitchId" id="pitchId" th:value="${pitchId}">
            <input type="hidden" name="amount" id="depositInput">
            <input type="hidden" name="date" id="hiddenDate">
            <input type="hidden" name="start" id="hiddenStart">
            <input type="hidden" name="end" id="hiddenEnd">
            <input type="hidden" name="total" id="hiddenTotal">
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ§¾ MODAL HÃ³a Ä‘Æ¡n -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg border-0 rounded-4">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title fw-bold" id="invoiceLabel">ğŸ§¾ HÃ³a Ä‘Æ¡n thanh toÃ¡n</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>ğŸŸï¸ SÃ¢n:</strong> <span id="modalPitchName" th:text="${pitchName}">SÃ¢n 5A</span></p>
          <p><strong>ğŸ“… NgÃ y & giá» thi Ä‘áº¥u:</strong> <span id="modalDate">--</span></p>
          <p><strong>ğŸ’° ThÃ nh tiá»n:</strong> <span id="modalTotal">0 Ä‘</span></p>
          <p><strong>ğŸ’µ Tiá»n cá»c cáº§n thanh toÃ¡n:</strong> <span id="modalDeposit" class="text-primary fw-bold">0 Ä‘</span></p>
          <p><strong>ğŸ§© Ná»™i dung chuyá»ƒn khoáº£n:</strong> 
            <span id="modalOrderInfo" class="text-danger fw-bold">Coc_SDT_MaDon</span>
          </p>
          <p class="text-muted"><i>ğŸ’¡ Kiá»ƒm tra ká»¹ thÃ´ng tin trÆ°á»›c khi báº¥m â€œThanh toÃ¡n qua VNPayâ€.</i></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âŒ Há»§y</button>
          <button type="button" class="btn btn-success" id="confirmPayBtn">ğŸ’³ Thanh toÃ¡n qua VNPay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… FOOTER -->
  <div th:replace="fragments/footer :: footer"></div>

  <!-- âœ… Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script th:if="${showAlert}" th:inline="javascript">
  Swal.fire({
    icon: 'warning',
    title: 'ThÃ´ng bÃ¡o',
    html: '[[${errorMessage}]]',
    confirmButtonColor: '#3085d6',
    confirmButtonText: 'ÄÃ£ hiá»ƒu'
  });
</script>
  <script th:inline="javascript">
  /*<![CDATA[*/
  const priceList = JSON.parse(/*[[${priceJson}]]*/ '[]');
  const depositRate = parseFloat(/*[[${depositRate}]]*/ 0.3);
  const openTime = /*[[${pitchOpen}]]*/ '06:00';
  const closeTime = /*[[${pitchClose}]]*/ '22:00';
  const sdt = /*[[${customerPhone}]]*/ '0000000000';
  const pitchIdVal = /*[[${pitchId}]]*/ 0;

  document.addEventListener("DOMContentLoaded", async () => {
    const date = document.getElementById("date");
    const startTime = document.getElementById("startTime");
    const endTime = document.getElementById("endTime");
    const price = document.getElementById("price");
    const deposit = document.getElementById("deposit");
    const tbody = document.getElementById("priceList");

    const today = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
    .toISOString()
    .split('T')[0];
    if (!date.value) date.value = today; // âœ… chá»‰ gÃ¡n náº¿u chÆ°a cÃ³ giÃ¡ trá»‹
    date.min = today; // váº«n giá»›i háº¡n khÃ´ng cho chá»n ngÃ y quÃ¡ khá»©


    // âœ… Hiá»ƒn thá»‹ báº£ng giÃ¡ thuÃª
    tbody.innerHTML = "";
    priceList.forEach(slot => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${slot.khungGioBatDau} - ${slot.khungGioKetThuc}</td>
                      <td>${slot.giaThue.toLocaleString('vi-VN')} Ä‘</td>`;
      tbody.appendChild(tr);
    });

    // ======== HÃ m tiá»‡n Ã­ch ========
    const parseTime = t => { if (!t) return null; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
    const toHM = m => `${String(Math.floor(m / 60)).padStart(2, '0')}:${m % 60 === 0 ? "00" : "30"}`;

    // ======== TÃ­nh tiá»n ========
    const calcPrice = (s, e) => {
      const sm = parseTime(s), em = parseTime(e);
      if (!sm || !em || em <= sm) return 0;
      let total = 0;
      for (const slot of priceList) {
        const ss = parseTime(slot.khungGioBatDau), ee = parseTime(slot.khungGioKetThuc);
        const os = Math.max(sm, ss), oe = Math.min(em, ee);
        if (oe > os) total += (oe - os) / 60 * slot.giaThue;
      }
      return Math.round(total);
    };
    const update = () => {
      const total = calcPrice(startTime.value, endTime.value);
      const coc = Math.round(total * depositRate);
      price.textContent = total.toLocaleString('vi-VN') + ' Ä‘';
      deposit.textContent = coc.toLocaleString('vi-VN') + ' Ä‘';
    };
    startTime.onchange = endTime.onchange = update;

    // ======== Load giá» Ä‘Ã£ Ä‘áº·t ========
    async function loadBookedSlots() {
      const res = await fetch(`/customer/booked-slots?pitchId=${pitchIdVal}&date=${date.value}`);
      const booked = await res.json();
      fillTimeOptions(booked);
    }

    function fillTimeOptions(booked) {
    	  startTime.innerHTML = "";
    	  endTime.innerHTML = "";

    	  const openM  = parseTime(openTime);
    	  const closeM = parseTime(closeTime);
    	  const now = new Date();
    	  const toISODate = (d) => {
    		  if (!d) return "";
    		  const parts = d.includes("-") ? d.split("-") : d.split("/");
    		  // Náº¿u dáº¡ng dd/mm/yyyy -> Ä‘áº£o láº¡i
    		  return parts[0].length === 4
    		    ? d
    		    : `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(2, "0")}`;
    		};

    		const isToday = toISODate(date.value) === today;

    	  // START: open â†’ close - 30
    	  for (let m = openM; m < closeM; m += 30) {
    	    const timeStr = toHM(m);
    	    const opt = document.createElement("option");
    	    opt.value = timeStr;
    	    opt.textContent = timeStr;

    	    let disabled = false;
    	    if (isToday) {
    	      const nowM = now.getHours() * 60 + now.getMinutes();
    	      if (m <= nowM) disabled = true;
    	    }
    	    for (const slot of booked) {
    	      const [s, e] = slot.split("-");
    	      if (parseTime(timeStr) >= parseTime(s) && parseTime(timeStr) < parseTime(e)) {
    	        disabled = true; break;
    	      }
    	    }
    	    if (disabled) {
    	      opt.disabled = true;
    	      opt.title = "â›” Giá» nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t hoáº·c Ä‘Ã£ qua";
    	    }
    	    startTime.appendChild(opt);
    	  }

    	  // END: open + 30 â†’ close (bao gá»“m 23:00)
    	  for (let m = openM + 30; m <= closeM; m += 30) {
    	    const timeStr = toHM(m);
    	    const opt = document.createElement("option");
    	    opt.value = opt.textContent = timeStr;

    	    let disabled = false;
    	    if (isToday) {
    	      const nowM = now.getHours() * 60 + now.getMinutes();
    	      if (m <= nowM) disabled = true;
    	    }
    	    for (const slot of booked) {
    	      const [s, e] = slot.split("-");
    	      // náº¿u káº¿t thÃºc rÆ¡i vÃ o khoáº£ng Ä‘Ã£ Ä‘áº·t, vÃ´ hiá»‡u
    	      if (parseTime(timeStr) > parseTime(s) && parseTime(timeStr) <= parseTime(e)) {
    	        disabled = true; break;
    	      }
    	    }
    	    if (disabled) {
    	      opt.disabled = true;
    	      opt.title = "â›” Giá» nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t hoáº·c Ä‘Ã£ qua";
    	    }
    	    endTime.appendChild(opt);
    	  }
    	}


    date.addEventListener("change", loadBookedSlots);
    await loadBookedSlots();

    // ======== NÃºt xÃ¡c nháº­n ========
    document.querySelector(".btn-confirm").onclick = () => {
      const d = date.value, s = startTime.value, e = endTime.value;
      if (!d || !s || !e) return alert("âš ï¸ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!");
      if (parseTime(s) >= parseTime(e)) return alert("âš ï¸ Giá» báº¯t Ä‘áº§u pháº£i nhá» hÆ¡n giá» káº¿t thÃºc!");

      const total = calcPrice(s, e);
      if (total <= 0) return alert("âš ï¸ KhÃ´ng cÃ³ khung giá» há»£p lá»‡!");

      const coc = Math.round(total * depositRate);
      modalDate.textContent = `${d} (${s} - ${e})`;
      modalTotal.textContent = total.toLocaleString('vi-VN') + ' Ä‘';
      modalDeposit.textContent = coc.toLocaleString('vi-VN') + ' Ä‘';
      modalOrderInfo.textContent = `Coc_${sdt}_${pitchIdVal}`;

      depositInput.value = coc;
      hiddenDate.value = d;
      hiddenStart.value = s;
      hiddenEnd.value = e;
      hiddenTotal.value = total;

      new bootstrap.Modal(invoiceModal).show();
    };

    confirmPayBtn.onclick = () => bookingForm.submit();
  });
  /*]]>*/
  </script>
</body>
</html>
