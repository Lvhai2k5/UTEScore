<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="${pageTitle}">‚öΩ Danh s√°ch S√¢n | UTEScore</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
html, body {
  height: 100%;
  margin: 0;
  overflow-x: hidden;
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: linear-gradient(180deg, #f9fafb 0%, #e2e8f0 100%);
}

/* ===== HEADER & FOOTER ===== */
header, nav.navbar {
  background: linear-gradient(90deg, #16a34a, #3b82f6);
  color: white;
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 1050;
  box-shadow: 0 2px 15px rgba(0, 0, 0, 0.25);
}
/* ================= CHATBOT ================= */
.chat-icon {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: linear-gradient(90deg, #16a34a, #3b82f6);
  color: white;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 28px;
  cursor: pointer;
  z-index: 9999;
  transition: all 0.3s ease;
  box-shadow: 0 6px 15px rgba(0,0,0,0.25);
}
.chat-icon:hover {
  transform: scale(1.1);
}

.chat-box {
  position: fixed;
  bottom: 100px;
  right: 25px;
  width: 320px;
  max-height: 450px;
  display: none;
  flex-direction: column;
  background: #fff;
  border-radius: 12px;
  z-index: 10000;
}

.chat-header {
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  font-weight: 600;
}

.chat-body {
  overflow-y: auto;
  max-height: 340px;
  font-size: 15px;
}

.chat-body::-webkit-scrollbar {
  width: 6px;
}
.chat-body::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

.user-msg, .bot-msg {
  border-radius: 12px;
  padding: 10px 14px;
  max-width: 80%;
  line-height: 1.4;
}

.user-msg {
  background: #3b82f6;
  color: white;
  margin-left: auto;
  text-align: right;
}

.bot-msg {
  background: #f1f5f9;
  color: #111827;
  margin-right: auto;
}

main.container {
  margin-top: 130px;
  margin-bottom: 150px;
  max-width: 1400px;
  animation: fadeInUp 0.6s ease-in-out;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

h3.page-title {
  text-align: center;
  font-weight: 800;
  color: #1d4ed8;
  margin-bottom: 35px;
  text-shadow: 0 1px 4px rgba(59,130,246,0.25);
}

/* ===== FILTER PANEL ===== */
.filter-box {
  background: #ffffff;
  border-radius: 25px;
  padding: 40px 60px;
  box-shadow: 0 10px 45px rgba(0, 0, 0, 0.08);
  transition: all 0.4s ease;
  max-width: 1300px;
  margin: 0 auto;
  transform: scale(1);
}
.filter-box:hover {
  transform: scale(1.02);
  box-shadow: 0 15px 60px rgba(37, 99, 235, 0.25);
}

label.form-label {
  font-weight: 600;
  color: #1e3a8a;
  font-size: 0.95rem;
}

input.form-control, select.form-select {
  border-radius: 14px;
  border: 1px solid #cbd5e1;
  height: 46px;
  font-size: 0.95rem;
  transition: all 0.25s ease;
}
input.form-control:focus, select.form-select:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 0.2rem rgba(59,130,246,0.25);
}

.time-range {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin-top: 10px;
}
.time-range input {
  width: 180px;
  text-align: center;
}

/* N√∫t t√¨m ki·∫øm */
.btn-search {
  background: linear-gradient(135deg, #16a34a, #3b82f6);
  border: none;
  color: #fff;
  font-weight: 600;
  border-radius: 40px;
  padding: 14px 60px;
  box-shadow: 0 6px 25px rgba(59,130,246,0.4);
  transition: all 0.4s ease;
}
.btn-search:hover {
  background: linear-gradient(135deg, #22c55e, #2563eb);
  transform: scale(1.05);
  box-shadow: 0 12px 35px rgba(34,197,94,0.35);
}

/* ===== PITCH CARD ===== */
.pitch-card {
  background: #fff;
  border-radius: 22px;
  overflow: hidden;
  box-shadow: 0 6px 25px rgba(0,0,0,0.08);
  transition: all 0.4s ease;
  height: 100%;
  display: flex;
  flex-direction: column;
  transform: scale(1);
}
.pitch-card:hover {
  transform: scale(1.05);
  box-shadow: 0 18px 40px rgba(0,0,0,0.15);
}

.pitch-img {
  height: 230px;
  overflow: hidden;
}
.pitch-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s ease;
}
.pitch-photo:hover {
  transform: scale(1.1);
}

.pitch-body {
  flex-grow: 1;
  padding: 20px;
  text-align: center;
}
.pitch-body h5 {
  font-weight: 800;
  color: #1e293b;
  margin-bottom: 8px;
}
.pitch-body p {
  color: #64748b;
  font-size: 0.9rem;
  margin-bottom: 4px;
}
.price-box {
  color: #059669;
  font-weight: 600;
  font-size: 0.95rem;
  margin-top: 8px;
}

/* T√≠nh nƒÉng */
.feature-badge {
  font-size: 0.85rem;
  padding: 7px 13px;
  border-radius: 18px;
  color: #fff;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: transform 0.3s ease;
}
.feature-badge:hover { transform: scale(1.1); }
.feature-badge:nth-child(1){background:#3b82f6;}
.feature-badge:nth-child(2){background:#10b981;}
.feature-badge:nth-child(3){background:#f59e0b;}
.feature-badge:nth-child(4){background:#ec4899;}
.feature-badge:nth-child(5){background:#8b5cf6;}

/* N√∫t h√†nh ƒë·ªông */
.btn-group-pitch {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
}
.btn-group-pitch a, .btn-group-pitch button {
  flex: 1;
  max-width: 140px;
  border-radius: 30px;
  font-weight: 600;
  font-size: 0.9rem;
  padding: 11px 0;
  transition: all 0.3s ease;
}
.btn-detail {
  background: #e2e8f0;
  color: #1e293b;
  border: none;
}
.btn-detail:hover { background: #cbd5e1; }
.btn-book {
  background: linear-gradient(90deg, #3b82f6, #16a34a);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(59,130,246,0.3);
}
.btn-book:hover {
  background: linear-gradient(90deg, #22c55e, #2563eb);
  transform: scale(1.05);
}
.btn-disabled {
  background: #e5e7eb;
  color: #6b7280;
  border: none;
  cursor: not-allowed;
}

/* Responsive */
@media (max-width: 992px) {
  .filter-box { padding: 30px 25px; }
  .pitch-img { height: 200px; }
}
@media (max-width: 768px) {
  .btn-search { width: 100%; padding: 12px 0; }
  .pitch-img { height: 180px; }
}
</style>
</head>

<body>
<header th:replace="~{fragments/header :: header}"></header>

<main class="container">
  <h3 class="page-title">‚öΩ Danh s√°ch S√¢n B√≥ng</h3>

  <!-- B·ªô l·ªçc -->
  <form class="filter-box" th:action="@{/customer/pitch-list}" method="post">
    <div class="row g-4 justify-content-center text-center">
      <!-- H√†ng 1 -->
      <div class="col-lg-3 col-md-6">
        <label class="form-label">T·ª´ kh√≥a</label>
        <input type="text" name="keyword" class="form-control" placeholder="T√™n s√¢n ho·∫∑c khu v·ª±c" th:value="${keyword}">
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Lo·∫°i s√¢n</label>
        <select class="form-select" name="loaiSan">
          <option value="">T·∫•t c·∫£</option>
          <option value="S√¢n 5" th:selected="${loaiSan == 'S√¢n 5'}">S√¢n 5</option>
          <option value="S√¢n 7" th:selected="${loaiSan == 'S√¢n 7'}">S√¢n 7</option>
          <option value="S√¢n 11" th:selected="${loaiSan == 'S√¢n 11'}">S√¢n 11</option>
        </select>
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">Tr·∫°ng th√°i</label>
        <select class="form-select" name="trangThai">
          <option value="">T·∫•t c·∫£</option>
          <option value="Ho·∫°t ƒë·ªông" th:selected="${trangThai == 'Ho·∫°t ƒë·ªông'}">Ho·∫°t ƒë·ªông</option>
          <option value="B·∫£o tr√¨" th:selected="${trangThai == 'B·∫£o tr√¨'}">B·∫£o tr√¨</option>
          <option value="Ng∆∞ng s·ª≠ d·ª•ng" 
        th:selected="${trangThai == 'T·∫°m ƒë√≥ng' or trangThai == 'Vƒ©nh vi·ªÖn'}">
  Ng∆∞ng s·ª≠ d·ª•ng
</option>
        </select>
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label">T√≠nh nƒÉng</label>
        <select class="form-select" name="maTinhNang">
          <option value="">T·∫•t c·∫£</option>
          <option th:each="tn : ${dsTinhNang}" th:value="${tn.maTinhNang}" th:text="${tn.tenTinhNang}" th:selected="${maTinhNang == tn.maTinhNang}"></option>
        </select>
      </div>
    </div>

    <!-- Gi·ªù ƒë√° -->
    <div class="text-center mt-4">
      <label class="form-label d-block mb-1 fw-semibold text-primary">Gi·ªù ƒë√°</label>
      <div class="time-range">
        <input type="time" name="gioBatDau" class="form-control w-auto text-center" th:value="${gioBatDau}">
        <span class="mx-2">‚ü∂</span>
        <input type="time" name="gioKetThuc" class="form-control w-auto text-center" th:value="${gioKetThuc}">
      </div>
    </div>

    <div class="text-center mt-4">
      <button type="submit" class="btn-search">üîç T√¨m ki·∫øm</button>
    </div>
  </form>

  <!-- Danh s√°ch s√¢n -->
  <div class="row g-4 mt-5" th:if="${!#lists.isEmpty(pitchList)}">
    <div class="col-12 col-sm-6 col-md-4 col-lg-3" th:each="p : ${pitchList}">
      <div class="pitch-card">
        <div class="pitch-img">
          <img th:src="${p.imageUrl}" alt="·∫¢nh s√¢n" class="pitch-photo">
        </div>
        <div class="pitch-body">
          <h5 th:text="${p.name}">S√¢n 5A</h5>
          <p>üìç <span th:text="${p.area}">Khu A</span></p>
          <p>üë• Lo·∫°i s√¢n: <span th:text="${p.type}">5 ng∆∞·ªùi</span></p>

          <div class="price-box" th:utext="${p.priceFormatted}">
            <span style="color: gray">Ch∆∞a c·∫≠p nh·∫≠t gi√°</span>
          </div>

          <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
            <span th:each="f : ${p.features}" th:text="${f}" class="feature-badge"></span>
          </div>

          <div class="btn-group-pitch">
            <a th:href="@{/customer/pitch-detail/{id}(id=${p.id})}" class="btn-detail">üîç Chi ti·∫øt</a>
            <button class="btn btn-success btn-book" th:if="${p.active}" th:attr="data-pitch-id=${p.id}" onclick="redirectPitch(this)">‚öΩ ƒê·∫∑t s√¢n ngay</button>
            <button class="btn-disabled" th:unless="${p.active}" disabled>üõë T·∫°m ng∆∞ng</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div th:if="${#lists.isEmpty(pitchList)}" class="text-center text-muted mt-5">
    <p>Kh√¥ng t√¨m th·∫•y s√¢n ph√π h·ª£p v·ªõi ti√™u ch√≠ c·ªßa b·∫°n.</p>
  </div>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<form id="bookingForm" th:action="@{/customer/booking}" method="post">
  <input type="hidden" name="pitchId" id="pitchId">
</form>

<script>
function redirectPitch(button) {
  const pitchId = button.getAttribute("data-pitch-id");
  if (pitchId) {
    document.getElementById("pitchId").value = pitchId;
    document.getElementById("bookingForm").submit();
  } else {
    alert("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh s√¢n c·∫ßn ƒë·∫∑t!");
  }
}
</script>
  <!-- üí¨ N√∫t Chat n·ªïi -->
<div id="chatIcon" class="chat-icon">
  <i class="bi bi-chat-dots-fill"></i>
</div>

<!-- üí¨ H·ªôp Chatbot -->
<div id="chatBox" class="chat-box card shadow-lg">
  <div class="chat-header bg-success text-white d-flex justify-content-between align-items-center p-2 rounded-top">
    <span>ü§ñ UTEScore Chatbot</span>
    <button class="btn btn-sm btn-light" id="closeChat"><i class="bi bi-x"></i></button>
  </div>
  <div class="chat-body p-3" id="chatMessages">
    <div class="bot-msg mb-3">
      Xin ch√†o üëã! T√¥i l√† tr·ª£ l√Ω ·∫£o UTEScore.<br>H√£y h·ªèi t√¥i v·ªÅ <b>gi√° s√¢n, l·ªãch s·ª≠ ƒë·∫∑t s√¢n</b> ho·∫∑c th√¥ng tin khuy·∫øn m√£i nh√©!
    </div>
  </div>
  <div class="chat-footer p-2 d-flex border-top">
    <input type="text" id="chatInput" class="form-control me-2" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button class="btn btn-success" id="sendChat"><i class="bi bi-send-fill"></i></button>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const chatIcon = document.getElementById("chatIcon");
  const chatBox = document.getElementById("chatBox");
  const closeChat = document.getElementById("closeChat");
  const sendChat = document.getElementById("sendChat");
  const chatInput = document.getElementById("chatInput");
  const chatMessages = document.getElementById("chatMessages");

  // üü¢ Hi·ªÉn th·ªã / ·∫®n khung chat
  chatIcon.addEventListener("click", () => {
    chatBox.style.display = "flex";
    chatIcon.style.display = "none";
  });

  closeChat.addEventListener("click", () => {
    chatBox.style.display = "none";
    chatIcon.style.display = "flex";
  });

  // ‚öôÔ∏è G·ª≠i tin nh·∫Øn
  async function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    // üü¢ Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng
    const userDiv = document.createElement("div");
    userDiv.className = "user-msg mb-2";
    userDiv.textContent = text;
    chatMessages.appendChild(userDiv);
    chatInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // üü° T·∫°o khung ph·∫£n h·ªìi t·∫°m
    const botDiv = document.createElement("div");
    botDiv.className = "bot-msg mb-2";
    botDiv.innerHTML = "‚è≥ ƒêang tr·∫£ l·ªùi...";
    chatMessages.appendChild(botDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // üîÑ G·ª≠i request ƒë·∫øn server
    try {
      const response = await fetch("/customer/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });

      if (!response.ok) {
        throw new Error("HTTP " + response.status);
      }

      const data = await response.json();
      botDiv.innerHTML = sanitizeText(data.answer || "‚ùå Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ chatbot.");
    } catch (error) {
      console.error("Chatbot error:", error);
      botDiv.innerHTML = "‚ö†Ô∏è L·ªói khi k·∫øt n·ªëi ƒë·∫øn chatbot. Vui l√≤ng th·ª≠ l·∫°i sau.";
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // ‚úÖ G·ª≠i khi b·∫•m n√∫t
  sendChat.addEventListener("click", sendMessage);

  // ‚úÖ G·ª≠i khi nh·∫•n Enter
  chatInput.addEventListener("keypress", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // üßπ Ch·ªëng l·ªói XSS c∆° b·∫£n khi hi·ªÉn th·ªã
  function sanitizeText(text) {
    if (!text) return "";
    return text
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\n/g, "<br>");
  }
});
</script>
</body>
</html>
