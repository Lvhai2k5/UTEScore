<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTEScore ‚Äì Chat Kh√°ch h√†ng</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Inter',system-ui;
    background:linear-gradient(135deg,#2563eb,#9333ea);
    display:flex;
    height:100vh;
    color:#f8fafc;
    overflow:hidden;
  }

  /* SIDEBAR */
  .sidebar{
    width:300px;
    background:rgba(15,23,42,0.75);
    backdrop-filter:blur(16px);
    color:#fff;
    padding:24px;
    overflow-y:auto;
    box-shadow:4px 0 25px rgba(0,0,0,0.4);
    animation:slideInLeft 1s ease;
  }

  .sidebar h3{
    font-size:18px;
    font-weight:700;
    text-align:center;
    background:linear-gradient(90deg,#60a5fa,#a78bfa);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    margin-bottom:16px;
  }

  label{font-size:14px;color:#e2e8f0}
  select{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:0;
    margin:8px 0;
    background:rgba(255,255,255,0.1);
    color:#fff;
    font-size:15px;
    outline:none;
  }

  button{
    background:linear-gradient(90deg,#38bdf8,#3b82f6);
    border:0;
    border-radius:10px;
    padding:10px 16px;
    color:white;
    font-weight:600;
    cursor:pointer;
    transition:all .25s;
  }
  button:hover{
    background:linear-gradient(90deg,#60a5fa,#3b82f6);
    transform:translateY(-2px);
  }

  .conv{
    padding:12px;
    border-radius:14px;
    margin:10px 0;
    background:rgba(255,255,255,0.1);
    cursor:pointer;
    transition:all .25s;
  }
  .conv:hover{
    background:rgba(255,255,255,0.25);
    transform:translateX(6px);
  }
  .conv b{font-size:15px;color:#f9fafb}
  .conv small{display:block;margin-top:2px;color:#cbd5e1;font-size:13px}

  /* CONTENT */
  .content{
    flex:1;
    display:flex;
    flex-direction:column;
    background:radial-gradient(circle at top left,#f0f9ff 0%,#e0e7ff 50%,#fdf4ff 100%);
    color:#1e293b;
    animation:fadeIn 1.2s ease;
  }

  .header{
    padding:18px 24px;
    background:#fff;
    border-bottom:1px solid #e2e8f0;
    font-weight:700;
    font-size:20px;
    color:#1e293b;
    box-shadow:0 4px 10px rgba(0,0,0,0.05);
    display:flex;
    align-items:center;
    gap:16px;
  }

  .back-btn{
    background:linear-gradient(90deg,#6366f1,#9333ea);
    color:white;
    border:none;
    padding:8px 16px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    transition:all .25s ease;
    box-shadow:0 3px 8px rgba(0,0,0,0.2);
  }
  .back-btn:hover{
    transform:scale(1.05);
    filter:brightness(1.1);
  }

  .messages{
    flex:1;
    padding:24px;
    overflow-y:auto;
    background:linear-gradient(180deg,#f1f5f9,#f8fafc);
  }

  .msg{
    max-width:65%;
    margin:10px 0;
    padding:12px 18px;
    border-radius:16px;
    background:#fff;
    color:#0f172a;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    animation:fadeUp .3s ease;
  }

  .msg.me{
    margin-left:auto;
    background:linear-gradient(135deg,#06b6d4,#0ea5e9);
    color:white;
    box-shadow:0 6px 16px rgba(14,165,233,0.4);
  }

  .composer{
    display:flex;
    gap:10px;
    padding:14px 20px;
    background:rgba(255,255,255,0.95);
    border-top:1px solid #e2e8f0;
    backdrop-filter:blur(6px);
  }

  .composer input{
    flex:1;
    padding:12px 16px;
    border:1px solid #cbd5e1;
    border-radius:12px;
    font-size:15px;
    transition:all .25s;
  }

  .composer input:focus{
    outline:none;
    border-color:#3b82f6;
    box-shadow:0 0 0 3px rgba(59,130,246,0.3);
  }

  .composer button{
    padding:12px 20px;
    border:0;
    border-radius:12px;
    background:linear-gradient(90deg,#3b82f6,#2563eb);
    color:white;
    font-weight:600;
    cursor:pointer;
    transition:background .25s ease,transform .2s;
  }
  .composer button:hover{
    background:linear-gradient(90deg,#60a5fa,#3b82f6);
    transform:translateY(-2px);
  }

  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideInLeft{from{transform:translateX(-100px);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head>
<body>
  <aside class="sidebar">
    <h3>üí¨ Xin ch√†o, <span th:text="${khachHangDangNhap.hoTen}">Kh√°ch h√†ng</span></h3>
    <label>Ch·ªçn Nh√¢n vi√™n h·ªó tr·ª£</label>
    <select id="nvSelect">
      <option th:each="nv : ${nhanViens}" th:value="${nv.userID}" th:text="${nv.fullName}"></option>
    </select>
    <button id="startBtn">B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán üöÄ</button>

    <hr style="margin:16px 0;border:0;height:1px;background:rgba(255,255,255,0.2)">
    <div th:each="c : ${conversations}" class="conv" th:attr="data-id=${c.id},data-nv=${c.nhanVien.userID}">
      <div><b th:text="${c.nhanVien.fullName}">T√™n NV</b></div>
      <small th:text="${#temporals.format(c.lastMessageAt, 'HH:mm dd/MM')}">--</small>
    </div>
  </aside>

  <main class="content">
    <div class="header">
      <button class="back-btn" onclick="window.location.href='/customer/home'">‚Üê Quay v·ªÅ</button>
      <span id="chatTitle">Ch·ªçn nh√¢n vi√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu üí¨</span>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <input id="input" placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..." />
      <button id="sendBtn">G·ª≠i ‚ú®</button>
    </div>
  </main>

<script th:inline="javascript">
  const khId = /*[[${khachHangDangNhap.maKhachHang}]]*/ 0;
  let convId = null; let nvId = null; let stomp = null;

  function connect(conversationId){
    const sock = new SockJS('/ws-chat');
    stomp = Stomp.over(sock);
    stomp.connect({}, () => {
      stomp.subscribe('/topic/chat/' + conversationId, (frame) => {
        const msg = JSON.parse(frame.body);
        renderMessage(msg);
      });
    });
  }

  async function openConversation(khachHangId, nhanVienId){
    const res = await fetch(`/api/chat/conversation?khachHangId=${khachHangId}&nhanVienId=${nhanVienId}`);
    convId = await res.json();
    document.getElementById('chatTitle').textContent = 'üí¨ ƒêang chat v·ªõi nh√¢n vi√™n #' + nhanVienId;
    if(stomp) try{stomp.disconnect(()=>{});}catch(err){}
    connect(convId);
    await loadHistory(convId);
  }

  async function loadHistory(conversationId){
    const res = await fetch(`/api/chat/${conversationId}/messages`);
    const data = await res.json();
    const box = document.getElementById('messages');
    box.innerHTML = '';
    data.forEach(renderMessage);
    box.scrollTop = box.scrollHeight;
  }

  function renderMessage(m){
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'msg ' + (m.senderType === 'KHACH_HANG' ? 'me' : '');
    div.textContent = m.content;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  document.getElementById('startBtn').addEventListener('click', async () => {
    nvId = document.getElementById('nvSelect').value;
    if(!nvId) return;
    await openConversation(khId, nvId);
  });

  document.querySelectorAll('.conv').forEach(e => {
    e.addEventListener('click', async () => {
      convId = e.dataset.id; nvId = e.dataset.nv;
      document.getElementById('chatTitle').textContent = 'üí¨ ƒêang chat v·ªõi nh√¢n vi√™n #' + nvId;
      if(stomp) try{stomp.disconnect(()=>{});}catch(err){}
      connect(convId);
      await loadHistory(convId);
    });
  });

  document.getElementById('sendBtn').addEventListener('click', () => {
    const content = document.getElementById('input').value.trim();
    if(!content || !convId) return;
    stomp.send('/app/chat.send', {}, JSON.stringify({
      conversationId: Number(convId),
      khachHangId: Number(khId),
      nhanVienId: null,
      content
    }));
    document.getElementById('input').value='';
  });
</script>
</body>
</html>
