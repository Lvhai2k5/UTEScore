<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="${pageTitle}">📜 Lịch sử đặt sân | UTEScore</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ✅ Bootstrap & Icons -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
	rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html, body {
	height: 100%;
	margin: 0;
	font-family: 'Segoe UI', Tahoma, sans-serif;
	background: linear-gradient(180deg, #f8fafc, #e2e8f0);
	overflow-x: hidden;
}
.main-content {
  background: #f8fafc;
  padding-top: 90px;      /* chừa khoảng trống cho header cố định */
  padding-bottom: 100px;  /* tránh footer che nội dung cuối */
  min-height: calc(100vh - 120px);
  overflow: visible;
  position: relative;     /* ✅ để footer theo luồng bình thường */
}

.history-wrapper {
	background: #fff;
	border-radius: 16px;
	box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
	max-width: 1150px;
	margin: auto;
	padding: 30px;
	animation: fadeIn 0.5s ease;
}

keyframes fadeIn {from { opacity:0;
	transform: translateY(10px);
}

to {
	opacity: 1;
	transform: translateY(0);
}

}
h3.title {
	font-weight: 700;
	color: #1e293b;
	text-align: center;
	margin-bottom: 25px;
}

.filter-box {
	background: #f1f5f9;
	border-radius: 12px;
	padding: 20px;
	margin-bottom: 25px;
}

.table thead th {
	background: linear-gradient(90deg, #16a34a, #3b82f6);
	color: white;
	text-align: center;
	font-weight: 600;
}

.table td {
	text-align: center;
	vertical-align: middle;
	color: #374151;
	font-size: 15px;
}

.btn-view, .btn-danger, .btn-warning, .btn-info {
	border: none;
	font-weight: 500;
	transition: 0.2s;
}

.btn-view {
	background: linear-gradient(90deg, #3b82f6, #2563eb);
	color: #fff;
}

.btn-warning {
	color: #000;
}

.btn-view:hover, .btn-danger:hover, .btn-warning:hover, .btn-info:hover
	{
	transform: translateY(-2px);
	opacity: 0.9;
}

.chart-section {
	margin-top: 40px;
	background: #f9fafb;
	border-radius: 12px;
	padding: 25px;
}

canvas {
	background: #fff;
	border-radius: 8px;
	padding: 10px;
	margin-top: 15px;
}

.countdown {
	font-weight: 600;
	display: inline-block;
	margin-bottom: 6px;
}

.modal-content {
	border-radius: 12px;
}
</style>
</head>

<body>
	<!-- HEADER -->
	<div th:replace="~{fragments/header :: header}"></div>
	<!-- MAIN CONTENT -->
	<div class="main-content">
		<div class="container">
			<div class="history-wrapper">
				<h3 class="title">📜 Lịch sử đặt sân</h3>

				<!-- Bộ lọc -->
				<form method="get" action="#" class="row g-3 filter-box">
					<div class="col-md-3">
						<label class="form-label fw-semibold">Từ ngày:</label> <input
							type="date" name="fromDate" th:value="${fromDate}"
							class="form-control">
					</div>
					<div class="col-md-3">
						<label class="form-label fw-semibold">Đến ngày:</label> <input
							type="date" name="toDate" th:value="${toDate}"
							class="form-control">
					</div>
					<div class="col-md-3 align-self-end">
						<button type="submit" class="btn btn-primary w-100">
							<i class="bi bi-search"></i> Lọc
						</button>
					</div>
					<div class="col-md-3 align-self-end">
						<a
							th:href="@{/customer/export-history(fromDate=${fromDate},toDate=${toDate})}"
							class="btn btn-success w-100"> <i
							class="bi bi-file-earmark-excel"></i> Xuất Excel
						</a>
					</div>
				</form>

				<!-- Danh sách đơn -->
				<div class="table-responsive">
					<table class="table table-bordered table-hover align-middle">
						<thead>
							<tr>
								<th>Mã đơn</th>
								<th>Tên sân</th>
								<th>Ngày thuê</th>
								<th>Khung giờ</th>
								<th>Tổng tiền</th>
								<th>Trạng thái</th>
								<th>Hành động</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="dto : ${bookingsView}">
								<td th:text="${dto.thueSan.maDonDat}"></td>
								<td th:text="${dto.thueSan.sanBong.tenSan}"></td>
								<td
									th:text="${#temporals.format(dto.thueSan.ngayThue,'dd/MM/yyyy')}"></td>
								<td
									th:text="${dto.thueSan.khungGioBatDau+' - '+dto.thueSan.khungGioKetThuc}"></td>
								<td
									th:text="${#numbers.formatDecimal(dto.thueSan.tongTien,0,'COMMA',0,'POINT')} + ' VNĐ'"></td>

								<!-- ✅ Trạng thái -->
								<td><span th:text="${dto.trangThai}"></span></td>

								<!-- ✅ Hành động -->
								<td>
									<!-- ⏳ Chưa thanh toán -->
									<div
										th:if="${dto.trangThai == '⏳ Chưa thanh toán (đang giữ chỗ)'}">
										<div th:if="${dto.countdownSeconds > 0}">
											<span class="badge bg-warning-subtle text-warning countdown"
												th:data-seconds="${dto.countdownSeconds}"> ⏳ Còn <span
												class="time-text">--:--</span> để thanh toán cọc
											</span>
											<div class="mt-2">
												<button class="btn btn-danger btn-sm cancel-btn me-1"
													th:data-madon="${dto.thueSan.maDonDat}">❌ Hủy</button>
												<button class="btn btn-warning btn-sm pay-deposit-btn"
													th:data-madon="${dto.thueSan.maDonDat}">💳 Thanh
													toán cọc</button>
											</div>
										</div>
										<div th:if="${dto.countdownSeconds <= 0}">
											<span class="text-muted fst-italic small"> ⏰ Hết thời
												gian giữ chỗ — vui lòng đặt lại. </span>
										</div>
									</div> <!-- 💵 Đã đặt cọc -->
									<div th:if="${dto.trangThai == '💵 Đã đặt cọc (30%)'}">
										<button class="btn btn-info btn-sm view-invoice-btn me-1"
											th:data-madon="${dto.thueSan.maDonDat}">🧾 Xem hóa
											đơn</button>
										<button class="btn btn-danger btn-sm refund-btn"
											th:data-madon="${dto.thueSan.maDonDat}">💸 Hoàn đơn</button>
									</div>
									<div
										th:if="${dto.trangThai == '💵 Đã đặt cọc — khách không đến'}">
										<button class="btn btn-view btn-sm view-invoice-btn"
											th:data-madon="${dto.thueSan.maDonDat}">👁️ Xem hóa
											đơn</button>
									</div> <!-- 💰 Đã thanh toán -->
									<div th:if="${dto.trangThai == '💰 Đã thanh toán (đủ tiền)'}">
										<button class="btn btn-success btn-sm view-invoice-btn"
											th:data-madon="${dto.thueSan.maDonDat}">🧾 Xem hóa
											đơn</button>
									</div> <!-- ✅ Hoàn tất -->
									<div th:if="${dto.trangThai == '✅ Hoàn tất (đã check-in)'}">
										<button class="btn btn-success btn-sm view-invoice-btn"
											th:data-madon="${dto.thueSan.maDonDat}">🧾 Xem hóa
											đơn</button>
									</div> <!-- 💸 Hoàn đơn thành công -->
									<div th:if="${dto.trangThai == '💸 Hoàn đơn (đã hoàn tiền)'}">
										<span class="badge bg-info-subtle text-info p-2">💸
											Hoàn đơn thành công</span>
										<button class="btn btn-view btn-sm mt-1 view-invoice-btn"
											th:data-madon="${dto.thueSan.maDonDat}">👁️ Xem hóa
											đơn</button>
									</div> <!-- ⏳ Đang chờ xử lý hoàn đơn -->
									<div th:if="${dto.trangThai == '⏳ Đang chờ xử lý hoàn đơn'}">
										<button class="btn btn-info btn-sm view-invoice-btn"
											th:data-madon="${dto.thueSan.maDonDat}">👁️ Xem hóa
											đơn</button>
									</div>
								</td>
							</tr>

							<tr th:if="${#lists.isEmpty(bookingsView)}">
								<td colspan="7" class="text-center text-muted">Không có dữ
									liệu.</td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- Phân trang -->
				<div
					class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
					<div class="text-muted small fw-medium">
						Trang <span th:text="${bookings.number + 1}">1</span> / <span
							th:text="${bookings.totalPages}">1</span> — Tổng <span
							th:text="${bookings.totalElements}">0</span> đơn
					</div>
					<nav aria-label="Page navigation">
						<ul class="pagination pagination-sm mb-0 shadow-sm rounded-pill">
							<li class="page-item"
								th:classappend="${bookings.first}? 'disabled'"><a
								class="page-link"
								th:href="@{/customer/history(page=${bookings.number},fromDate=${fromDate},toDate=${toDate})}">
									<i class="bi bi-chevron-left"></i>
							</a></li>
							<li th:each="i : ${#numbers.sequence(1, bookings.totalPages)}"
								class="page-item"
								th:classappend="${i == bookings.number + 1}? 'active'"><a
								class="page-link fw-semibold"
								th:href="@{/customer/history(page=${i},fromDate=${fromDate},toDate=${toDate})}"
								th:text="${i}">1</a></li>
							<li class="page-item"
								th:classappend="${bookings.last}? 'disabled'"><a
								class="page-link"
								th:href="@{/customer/history(page=${bookings.number + 2},fromDate=${fromDate},toDate=${toDate})}">
									<i class="bi bi-chevron-right"></i>
							</a></li>
						</ul>
					</nav>
				</div>

				<!-- Biểu đồ -->
				<div class="chart-section mt-5">
					<h5 class="fw-bold text-primary mb-3">📊 Số lượng đơn theo
						tháng</h5>
					<canvas id="chartStatus" height="130"></canvas>

					<h5 class="fw-bold text-success mt-5 mb-3">💳 Lịch sử giao
						dịch 3 tháng gần nhất</h5>
					<canvas id="chart3Months" height="130"></canvas>
				</div>
			</div>
		</div>
	</div>

	<!-- FOOTER -->
	<div th:replace="fragments/footer :: footer"></div>


	<!-- 🧾 TEMPLATE HÓA ĐƠN CHI TIẾT -->
	<div id="invoice-template" style="display: none;">
		<div class="invoice-pro p-4 shadow-sm rounded bg-white">
			<style>
.invoice-pro {
	font-family: 'Segoe UI', Tahoma, sans-serif;
	color: #111827;
	max-width: 700px;
	margin: auto;
	border: 1px solid #e5e7eb;
}

.invoice-pro p, .invoice-pro td, .invoice-pro th {
	text-align: left !important;
}

.invoice-header {
	text-align: center;
	border-bottom: 3px solid #16a34a;
	padding-bottom: 8px;
	margin-bottom: 10px;
}

.invoice-header h4 {
	color: #15803d;
	font-weight: 700;
	margin-bottom: 2px;
}

.invoice-header small {
	color: #6b7280;
}

.invoice-brand {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.invoice-brand img {
	height: 50px;
}

.invoice-brand .info {
	text-align: right;
	font-size: 14px;
	color: #374151;
}

.table th {
	background: #16a34a;
	color: white;
	text-align: center;
}

.table td {
	text-align: center;
	vertical-align: middle;
}

.total-line {
	font-weight: 600;
	background: #f1f5f9;
	border-radius: 8px;
	padding: 10px 15px;
	display: flex;
	justify-content: space-between;
}

.signatures {
	margin-top: 25px;
	display: flex;
	justify-content: space-between;
	text-align: center;
}

.sign-box {
	width: 45%;
	border-top: 1px solid #94a3b8;
	padding-top: 5px;
	font-size: 14px;
	color: #334155;
}
</style>

			<div class="invoice-brand mb-3">
				<div class="logo">
					<img th:src="@{/uploads/Logo.jpg}" alt="UTEScore Logo">
				</div>
				<div class="info">
					<strong>UTEScore Football</strong><br> Số 1 Võ Văn Ngân,
					Thủ Đức, TP.HCM<br> Hotline: 0344 969 875<br> Email:
					support@utescore.vn
				</div>
			</div>

			<div class="invoice-header">
				<h4>HÓA ĐƠN THANH TOÁN DỊCH VỤ</h4>
				<small id="inv-date"></small>
			</div>

			<div class="invoice-info mb-3">
				<p>
					<b>Mã đơn:</b> <span id="inv-madon"></span>
				</p>
				<p>
					<b>Khách hàng:</b> <span id="inv-khach"></span>
				</p>
				<p>
					<b>Sân bóng:</b> <span id="inv-san"></span>
				</p>
				<p>
					<b>Ngày thuê:</b> <span id="inv-ngay"></span>
				</p>
				<p>
					<b>Khung giờ:</b> <span id="inv-gio"></span>
				</p>
			</div>

			<h6
				class="fw-bold text-success mb-2 border-bottom border-success pb-1">💳
				Danh sách giao dịch</h6>
			<table class="table table-bordered table-sm mb-3">
				<thead>
					<tr>
						<th>Loại thanh toán</th>
						<th>Phương thức</th>
						<th>Số tiền</th>
						<th>Trạng thái</th>
						<th>Ngày</th>
					</tr>
				</thead>
				<tbody id="inv-payments">
					<tr>
						<td colspan="5" class="text-center text-muted">Đang tải...</td>
					</tr>
				</tbody>
			</table>

			<div class="total-line">
				<span>Tổng tiền sân:</span> <span id="inv-tong"></span>
			</div>

			<div class="signatures">
				<div class="sign-box">
					<b>Thu ngân</b><br>(Ký, ghi rõ họ tên)
				</div>
				<div class="sign-box">
					<b>Khách hàng</b><br>(Ký, ghi rõ họ tên)
				</div>
			</div>

			<p class="text-center text-muted mt-3 small fst-italic">© 2025
				UTEScore — Đã bao gồm thuế VAT</p>
		</div>
	</div>

	<!-- SCRIPT -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener("DOMContentLoaded", () => {
    // ❌ Hủy đơn
    document.querySelectorAll(".cancel-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        Swal.fire({
          title:"Bạn có chắc muốn hủy đơn này?",
          icon:"warning",showCancelButton:true,
          confirmButtonText:"Có, hủy ngay",cancelButtonText:"Không"
        }).then(r=>{if(r.isConfirmed)
          window.location.href=`/customer/cancel-booking?maDonDat=${btn.dataset.madon}`;});
      });
    });

    // 💳 Thanh toán cọc
    document.querySelectorAll(".pay-deposit-btn").forEach(btn=>{
      btn.addEventListener("click",()=>window.location.href=`/customer/payment/deposit?maDonDat=${btn.dataset.madon}`);});
 // 💸 Hoàn đơn 
    document.querySelectorAll(".refund-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const maDonDat = btn.dataset.madon;

    const { isConfirmed, value } = await Swal.fire({
      title: "🧾 Gửi yêu cầu hoàn đơn",
      html: `
        <div class="text-start">
          <p class="fw-semibold text-danger mb-2">
            ⚠️ Vui lòng kiểm tra kỹ thông tin trước khi gửi.<br>
            Sau khi gửi yêu cầu, bạn <b>không thể hoàn tác</b>.
          </p>

          <div class="mb-2">
            <label class="fw-semibold">Ngân hàng:</label>
            <input type="text" id="bank" class="form-control" placeholder="VD: Vietcombank, MB Bank...">
          </div>

          <div class="mb-2">
            <label class="fw-semibold">Số tài khoản:</label>
            <input type="text" id="account" class="form-control" placeholder="Nhập số tài khoản của bạn">
          </div>

          <div class="mb-2">
            <label class="fw-semibold">Lý do hoàn đơn:</label>
            <input type="text" id="reason" class="form-control" placeholder="VD: Bận việc đột xuất, đổi lịch...">
          </div>

          <div class="mb-2">
            <label class="fw-semibold">Mô tả thêm (ghi chú):</label>
            <textarea id="note" class="form-control" rows="3" placeholder="Ghi rõ thêm thông tin nếu cần..."></textarea>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: "Gửi yêu cầu hoàn đơn",
      cancelButtonText: "Hủy",
      focusConfirm: false,
      preConfirm: () => {
        const bank = document.getElementById("bank").value.trim();
        const account = document.getElementById("account").value.trim();
        const reason = document.getElementById("reason").value.trim();
        const note = document.getElementById("note").value.trim();

        if (!bank || !account || !reason) {
          Swal.showValidationMessage("Vui lòng nhập đầy đủ ngân hàng, số tài khoản và lý do hoàn đơn!");
          return false;
        }

        return { bank, account, reason, note };
      }
    });

    if (!isConfirmed) return;

    try {
      const res = await fetch(`/customer/refund-request?maDonDat=${maDonDat}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nganHang: value.bank,
          soTaiKhoan: value.account,
          lyDoHoan: value.reason,
          ghiChu: value.note
        })
      });
      const data = await res.json();

      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "✅ Đã gửi yêu cầu hoàn đơn",
          text: data.message,
          confirmButtonText: "Đóng"
        }).then(() => location.reload());
      } else {
        Swal.fire("Lỗi ⚠️", data.message, "error");
      }
    } catch (err) {
      Swal.fire("Lỗi hệ thống", err.message, "error");
    }
  });
});


    // 🧾 Xem hóa đơn
    // 🧾 Xem hóa đơn popup hiện đại
document.querySelectorAll(".view-invoice-btn").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const id = btn.dataset.madon;
    const res = await fetch(`/customer/api/invoice?maDonDat=${id}`);
    const data = await res.json();

    if(data.error){
      Swal.fire("Lỗi!", data.error, "error");
      return;
    }

    const tpl = document.querySelector("#invoice-template").innerHTML;
    const temp = document.createElement("div");
    temp.innerHTML = tpl;

    // Gán dữ liệu động
    temp.querySelector("#inv-date").textContent = new Date(data.ngayThue).toLocaleString("vi-VN");
    temp.querySelector("#inv-madon").textContent = data.maDonDat;
    temp.querySelector("#inv-khach").textContent = data.khachHang;
    temp.querySelector("#inv-san").textContent = data.sanBong;
    temp.querySelector("#inv-ngay").textContent = new Date(data.ngayThue).toLocaleDateString("vi-VN");
    temp.querySelector("#inv-gio").textContent = data.khungGio;
    temp.querySelector("#inv-tong").textContent = new Intl.NumberFormat("vi-VN").format(data.tongTien) + " VNĐ";

    const tbody = temp.querySelector("#inv-payments");
    tbody.innerHTML = data.thanhToans.length
      ? data.thanhToans.map(p => `
        <tr>
          <td>${p.loai}</td>
          <td>${p.pttt}</td>
          <td>${new Intl.NumberFormat("vi-VN").format(p.soTien)} VNĐ</td>
          <td>${p.trangThai === 'Thành công'
                ? '<span class="badge bg-success">Thành công</span>'
                : '<span class="badge bg-warning text-dark">'+p.trangThai+'</span>'}</td>
          <td>${new Date(p.ngay).toLocaleString("vi-VN")}</td>
        </tr>`).join("")
      : `<tr><td colspan="5" class="text-center text-muted">Chưa có giao dịch nào.</td></tr>`;

    Swal.fire({
      width: 800,
      html: temp.innerHTML,
      showConfirmButton: false,
      showCloseButton: true,
      background: "#f9fafb",
      scrollbarPadding: false
    });
  });
});
    // ⏱ Countdown
    document.querySelectorAll(".countdown").forEach(el=>{
      let seconds=parseInt(el.dataset.seconds||"0",10);
      const span=el.querySelector(".time-text");
      if(!seconds||seconds<=0){el.remove();return;}
      function tick(){
        if(seconds<=0){el.textContent="⏰ Hết thời gian giữ chỗ!";el.classList.add("text-muted");return;}
        const m=Math.floor(seconds/60),s=seconds%60;
        span.textContent=`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
        if(seconds<30)el.style.color="#dc2626";else if(seconds<60)el.style.color="#f97316";else el.style.color="#16a34a";
        seconds--;setTimeout(tick,1000);}
      tick();
    });

    // 📊 Biểu đồ
    const labelsStatus=/*[[${labelsStatus}]]*/[];
    const successData=/*[[${successData}]]*/[];
    const cancelData=/*[[${cancelData}]]*/[];
    const refundData=/*[[${refundData}]]*/[];
    new Chart(document.getElementById("chartStatus"),{
      type:"bar",
      data:{labels:labelsStatus,datasets:[
        {label:"Thành công/Đã đá",data:successData,backgroundColor:"#16a34a"},
        {label:"Đã hủy",data:cancelData,backgroundColor:"#ef4444"},
        {label:"Hoàn tiền",data:refundData,backgroundColor:"#60a5fa"}]},
      options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });

    const labels3=/*[[${labels3}]]*/[];
    const data3=/*[[${data3}]]*/[];
    new Chart(document.getElementById("chart3Months"),{
      type:"line",
      data:{labels:labels3,datasets:[{label:"Số tiền giao dịch (VNĐ)",data:data3,borderColor:"#2563eb",backgroundColor:"#93c5fd",fill:true,tension:0.3}]},
      options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });
  });
  /*]]>*/
  </script>
</body>
</html>
