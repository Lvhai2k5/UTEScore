<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTEScore ‚Äì Chat Nh√¢n vi√™n</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Inter',system-ui;
    background:linear-gradient(135deg,#1e3a8a,#9333ea);
    display:flex;
    height:100vh;
    color:#f8fafc;
    overflow:hidden;
  }

  /* SIDEBAR */
  .sidebar{
    width:300px;
    background:rgba(15,23,42,0.75);
    backdrop-filter:blur(16px);
    color:#fff;
    padding:24px;
    overflow-y:auto;
    box-shadow:4px 0 25px rgba(0,0,0,0.4);
    animation:slideInLeft 1s ease;
  }
  .sidebar h3{
    font-size:18px;
    font-weight:700;
    text-align:center;
    background:linear-gradient(90deg,#38bdf8,#a78bfa);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    margin-bottom:16px;
  }
  .conv{
    padding:12px;
    border-radius:14px;
    margin-bottom:10px;
    background:rgba(255,255,255,0.08);
    cursor:pointer;
    transition:all .25s ease;
  }
  .conv:hover{
    background:rgba(255,255,255,0.18);
    transform:translateX(6px);
  }
  .conv b{font-size:15px;color:#e2e8f0}
  .conv small{display:block;margin-top:2px;color:#94a3b8;font-size:13px}

  /* CONTENT */
  .content{
    flex:1;
    display:flex;
    flex-direction:column;
    background:radial-gradient(circle at top left,#f0f9ff 0%,#e0e7ff 50%,#fdf4ff 100%);
    color:#1e293b;
    animation:fadeIn 1.2s ease;
  }

  .header{
    padding:18px 24px;
    background:#fff;
    border-bottom:1px solid #e2e8f0;
    font-weight:700;
    font-size:20px;
    color:#1e293b;
    box-shadow:0 4px 10px rgba(0,0,0,0.05);
  }

  .messages{
    flex:1;
    padding:24px;
    overflow-y:auto;
    background:linear-gradient(180deg,#eef2ff,#f8fafc);
  }

  .msg{
    max-width:65%;
    margin:10px 0;
    padding:12px 18px;
    border-radius:16px;
    background:rgba(255,255,255,0.9);
    color:#0f172a;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    animation:fadeUp .3s ease;
  }

  .msg.me{
    margin-left:auto;
    background:linear-gradient(135deg,#22c55e,#16a34a);
    color:white;
    box-shadow:0 6px 16px rgba(34,197,94,0.4);
  }

  .composer{
    display:flex;
    gap:10px;
    padding:14px 20px;
    background:rgba(255,255,255,0.95);
    border-top:1px solid #e2e8f0;
    backdrop-filter:blur(6px);
  }

  .composer input{
    flex:1;
    padding:12px 16px;
    border:1px solid #cbd5e1;
    border-radius:12px;
    font-size:15px;
    transition:all .25s ease;
  }
  .composer input:focus{
    outline:none;
    border-color:#6366f1;
    box-shadow:0 0 0 3px rgba(99,102,241,0.3);
  }

  .composer button{
    padding:12px 20px;
    border:0;
    border-radius:12px;
    background:linear-gradient(90deg,#3b82f6,#2563eb);
    color:white;
    font-weight:600;
    cursor:pointer;
    transition:background .25s ease,transform .2s;
  }
  .composer button:hover{
    background:linear-gradient(90deg,#60a5fa,#3b82f6);
    transform:translateY(-2px);
  }

  /* ANIMATION */
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideInLeft{from{transform:translateX(-100px);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head>
<body>
  <aside class="sidebar">
    <h3>üí¨ Chat Nh√¢n Vi√™n</h3>
    <p style="text-align:center;font-size:14px;margin-bottom:10px;">
      Xin ch√†o, <h3 th:text="${nhanVienDangNhap.fullName}"></h3>
    </p>
    <hr style="border:0;height:1px;background:rgba(255,255,255,0.2);margin:10px 0;">
    <div th:each="c : ${conversations}" class="conv" th:attr="data-id=${c.id},data-kh=${c.khachHang.maKhachHang}">
      <div><b th:text="${c.khachHang.hoTen}">T√™n KH</b></div>
      <small th:text="${#temporals.format(c.lastMessageAt, 'HH:mm dd/MM')}">--</small>
    </div>
  </aside>

  <main class="content">
    <div class="header" style="display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:10px;">
    <button onclick="window.location.href='/employee'"
            style="background:linear-gradient(90deg,#6366f1,#9333ea);
                   color:white;border:none;padding:8px 14px;
                   border-radius:8px;font-weight:600;
                   cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2);
                   transition:all .25s ease;">
      ‚Üê Quay v·ªÅ
    </button>
    <span id="chatTitle" style="font-weight:700;font-size:20px;color:#1e293b;">
      Ch·ªçn kh√°ch h√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán ‚ú®
    </span>
  </div>
</div>


    <div class="messages" id="messages"></div>

    <div class="composer">
      <input id="input" placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..." />
      <button id="sendBtn">G·ª≠i üöÄ</button>
    </div>
  </main>

<script th:inline="javascript">
  const nvId = /*[[${nhanVienDangNhap.userID}]]*/ 0;
  let convId = null; let khId = null; let stomp = null;

  function connect(conversationId){
    const sock = new SockJS('/ws-chat');
    stomp = Stomp.over(sock);
    stomp.connect({}, () => {
      stomp.subscribe('/topic/chat/' + conversationId, (frame) => {
        const msg = JSON.parse(frame.body);
        renderMessage(msg);
      });
    });
  }

  async function loadHistory(conversationId){
    const res = await fetch(`/api/chat/${conversationId}/messages`);
    const data = await res.json();
    const box = document.getElementById('messages');
    box.innerHTML = '';
    data.forEach(renderMessage);
    box.scrollTop = box.scrollHeight;
  }

  function renderMessage(m){
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'msg ' + (m.senderType === 'NHAN_VIEN' ? 'me' : '');
    div.textContent = m.content;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  document.querySelectorAll('.conv').forEach(e => {
    e.addEventListener('click', async () => {
      convId = e.dataset.id; khId = e.dataset.kh;
      document.getElementById('chatTitle').textContent = 'üí¨ ƒêang tr√≤ chuy·ªán v·ªõi kh√°ch h√†ng #' + khId;
      if(stomp) try{stomp.disconnect(()=>{});}catch(err){}
      connect(convId);
      await loadHistory(convId);
    });
  });

  document.getElementById('sendBtn').addEventListener('click', () => {
    const content = document.getElementById('input').value.trim();
    if(!content || !convId) return;
    stomp.send('/app/chat.send', {}, JSON.stringify({
      conversationId: Number(convId),
      nhanVienId: Number(nvId),
      khachHangId: null,
      content
    }));
    document.getElementById('input').value='';
  });
</script>
</body>
</html>
