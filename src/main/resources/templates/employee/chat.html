<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ðŸ’¼ NhÃ¢n viÃªn â€“ TrÃ² chuyá»‡n</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box} body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);margin:0;padding:28px}
  .box{max-width:900px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);overflow:hidden}
  header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:14px 20px;font-weight:600;display:flex;justify-content:space-between}
  #messages{height:460px;overflow-y:auto;padding:16px;background:#f8fafc}
  .msg{margin-bottom:10px;display:flex;flex-direction:column}
  .mine{align-items:flex-end}
  .mine span{background:#667eea;color:#fff}
  .theirs{align-items:flex-start}
  .theirs span{background:#e2e8f0;color:#111827}
  span{display:inline-block;padding:10px 14px;border-radius:18px;max-width:70%;word-wrap:break-word}
  .input{display:flex;padding:12px;border-top:1px solid #e5e7eb;background:#fff}
  input{flex:1;padding:10px 14px;border-radius:18px;border:1px solid #cbd5e1}
  button{margin-left:8px;padding:10px 16px;border:0;border-radius:18px;background:#667eea;color:#fff;cursor:pointer}
</style>
</head>
<body>
<div class="box">
  <header>
    <div>ðŸ’¼ TrÃ² chuyá»‡n vá»›i khÃ¡ch</div>
    <div style="opacity:.9;font-size:14px">
      <span th:text="'Báº¡n: ' + ${sender}"></span> â€¢
      <span th:text="'KhÃ¡ch: ' + ${receiver}"></span>
    </div>
  </header>
  <div id="messages"></div>
  <div class="input">
    <input id="msg" type="text" placeholder="Nháº­p tin nháº¯n..." autocomplete="off">
    <button id="send">Gá»­i</button>
  </div>
</div>

<script th:inline="javascript">
  const sender = /*[[${sender}]]*/ "";
  const receiver = /*[[${receiver}]]*/ "";
  const sock = new SockJS('/ws-checkin');
  const stomp = Stomp.over(sock);
  const board = document.getElementById('messages');

  function add(user, text) {
    const d=document.createElement('div');
    d.className='msg ' + (user===sender?'mine':'theirs');
    d.innerHTML = `<span>${text}</span>`;
    board.appendChild(d); board.scrollTop=board.scrollHeight;
  }

  // lá»‹ch sá»­
  fetch(`/support/history?a=${encodeURIComponent(sender)}&b=${encodeURIComponent(receiver)}`)
    .then(r=>r.json()).then(list=>list.forEach(m=>add(m.sender,m.content)));

  // websocket
  stomp.connect({}, ()=>{
    stomp.subscribe(`/topic/chat/${sender}`, (frame)=>{
      const m=JSON.parse(frame.body); add(m.sender, m.content);
    });
  });

  // gá»­i
  document.getElementById('send').onclick=()=>{
    const t=document.getElementById('msg'); const v=t.value.trim();
    if(!v) return;
    stomp.send('/app/chat.send', {}, JSON.stringify({sender, receiver, content:v}));
    t.value='';
  };
  document.getElementById('msg').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('send').click(); });
</script>
</body>
</html>
